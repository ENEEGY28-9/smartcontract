name: Deploy with Docker - Zero Config

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy with Docker
      run: |
        docker run --rm -v ${{ github.workspace }}:/work -w /work \\
          -e SOLANA_PRIVATE_KEY=${{ secrets.SOLANA_PRIVATE_KEY }} \\
          ghcr.io/makemydeal/solana-anchor:latest \\
          /bin/bash -c "
            echo \$SOLANA_PRIVATE_KEY > ~/.config/solana/id.json && \\
            chmod 600 ~/.config/solana/id.json && \\
            solana config set --url devnet --keypair ~/.config/solana/id.json && \\
            solana airdrop 2 || true && \\
            anchor build && \\
            anchor deploy && \\
            PROGRAM_ID=$(solana address -k target/deploy/game_token-keypair.json) && \\
            echo \"## ðŸš€ SUCCESS\" > deployment_report.md && \\
            echo \"Program ID: $PROGRAM_ID\" >> deployment_report.md && \\
            echo \"Explorer: https://explorer.solana.com/address/$PROGRAM_ID?cluster=devnet\" >> deployment_report.md
          "
    
    - name: Upload Report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: deployment_report.md
