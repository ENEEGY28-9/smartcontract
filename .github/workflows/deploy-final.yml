name: Deploy Solana Smart Contract - Final Auto

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@1.70.0
      
    - name: Setup Solana CLI
      run: |
        sh -c "$(curl -sSfL https://release.solana.com/v1.18.4/install)"
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
        
    - name: Setup Anchor CLI
      run: |
        cargo install --git https://github.com/coral-xyz/anchor --tag v0.29.0 anchor-cli --locked
        export PATH="$HOME/.cargo/bin:$PATH"
        
    - name: Install Dependencies
      run: |
        npm install -g @solana/web3.js
        npm install -g yarn
        yarn install || true
        
    - name: Build Smart Contract
      run: |
        export PATH="$HOME/.cargo/bin:$PATH"
        anchor build
        
    - name: Deploy to Devnet
      run: |
        export PATH="$HOME/.cargo/bin:$PATH"
        mkdir -p ~/.config/solana
        echo "${{ secrets.SOLANA_PRIVATE_KEY }}" > ~/.config/solana/id.json
        chmod 600 ~/.config/solana/id.json
        solana config set --url devnet --keypair ~/.config/solana/id.json
        solana airdrop 2 || true
        anchor deploy
        
    - name: Extract Program ID
      id: program-id
      run: |
        export PATH="$HOME/.cargo/bin:$PATH"
        PROGRAM_ID=$(solana address -k target/deploy/game_token-keypair.json)
        echo "program_id=$PROGRAM_ID" >> $GITHUB_OUTPUT
        echo "Program ID: $PROGRAM_ID"
        
    - name: Generate Report
      run: |
        PROGRAM_ID="${{ steps.program-id.outputs.program_id }}"
        echo "## ðŸš€ DEPLOYMENT SUCCESS" > deployment_report.md
        echo "" >> deployment_report.md
        echo "### Program Details" >> deployment_report.md
        echo "- **Program ID**: \`$PROGRAM_ID\`" >> deployment_report.md
        echo "- **Network**: Solana Devnet" >> deployment_report.md
        echo "- **Explorer**: https://explorer.solana.com/address/$PROGRAM_ID?cluster=devnet" >> deployment_report.md
        echo "" >> deployment_report.md
        echo "### Deployment Time" >> deployment_report.md
        echo "- **Timestamp**: $(date)" >> deployment_report.md
        echo "" >> deployment_report.md
        echo "### Next Steps" >> deployment_report.md
        echo "1. Test the smart contract functions" >> deployment_report.md
        echo "2. Verify on Solana Explorer" >> deployment_report.md
        echo "3. Ready for mainnet deployment" >> deployment_report.md
 
 - name: Upload Report
 uses: actions/upload-artifact@v4
 with:
 name: deployment-report
 path: deployment_report.md
