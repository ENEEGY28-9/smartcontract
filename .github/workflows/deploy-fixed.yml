name: Deploy Solana Smart Contract Fixed

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source ~/.cargo/env

    - name: Setup Solana CLI
      run: |
        curl -sSfL https://release.solana.com/v1.18.4/install | sh
        export PATH=C:\Users\Fit/.local/share/solana/install/active_release/bin:

    - name: Setup Anchor
      run: |
        source ~/.cargo/env
        cargo install --git https://github.com/coral-xyz/anchor avm --locked
        avm install latest
        avm use latest

    - name: Build smart contract
      run: |
        source ~/.cargo/env
        anchor build

    - name: Deploy to devnet
      run: |
        mkdir -p ~/.config/solana
        echo ${{ secrets.SOLANA_PRIVATE_KEY }} > ~/.config/solana/id.json
        chmod 600 ~/.config/solana/id.json
        solana config set --url devnet --keypair ~/.config/solana/id.json
        solana airdrop 2 || true
        anchor deploy

    - name: Extract Program ID
      run: |
        PROGRAM_ID=$(solana address -k target/deploy/game_token-keypair.json)
        echo Program ID: $PROGRAM_ID
        echo ## Deployment Report > deployment_report.md
        echo - Program ID: $PROGRAM_ID >> deployment_report.md
        echo - Explorer: https://explorer.solana.com/address/$PROGRAM_ID?cluster=devnet >> deployment_report.md

    - name: Upload report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: deployment_report.md
