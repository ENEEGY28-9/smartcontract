name: üöÄ Automated Smart Contract Deployment

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      test_after_deploy:
        description: 'Run tests after deployment'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full
  SOLANA_CLI_VERSION: 1.18.26
  ANCHOR_VERSION: latest

jobs:
  deploy:
    name: Deploy Smart Contract to Devnet
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üîß Setup Rust Toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: üì¶ Cache Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: üõ†Ô∏è Setup Solana CLI
      run: |
        echo "Installing Solana CLI v${{ env.SOLANA_CLI_VERSION }}..."
        sh -c "$(curl -sSfL https://release.anza.xyz/v${{ env.SOLANA_CLI_VERSION }}/install)"
        echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
        export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"

        # Verify installation
        solana --version
        solana config set --url https://api.devnet.solana.com

    - name: ‚öì Setup Anchor Framework
      run: |
        echo "Installing Anchor AVM..."
        cargo install --git https://github.com/coral-xyz/anchor avm --locked --force

        echo "Installing latest Anchor..."
        avm install ${{ env.ANCHOR_VERSION }}
        avm use ${{ env.ANCHOR_VERSION }}

        # Verify installation
        anchor --version

    - name: üîë Setup Devnet Wallet
      run: |
        echo "Setting up devnet wallet..."
        mkdir -p ~/.config/solana

        # Generate new wallet for deployment
        solana-keygen new --no-bip39-passphrase --silent --outfile ~/.config/solana/id.json

        # Set as default
        solana config set --keypair ~/.config/solana/id.json

        # Show wallet address
        WALLET_ADDRESS=$(solana address)
        echo "Wallet Address: $WALLET_ADDRESS"
        echo "WALLET_ADDRESS=$WALLET_ADDRESS" >> $GITHUB_ENV

    - name: üí∞ Fund Wallet
      run: |
        echo "Requesting SOL airdrop..."
        WALLET_ADDRESS=$(solana address)
        echo "Current balance: $(solana balance)"

        # Request airdrop (with retry)
        for i in {1..5}; do
          echo "Airdrop attempt $i/5..."
          if solana airdrop 2; then
            echo "Airdrop successful!"
            break
          else
            echo "Airdrop failed, waiting 10 seconds..."
            sleep 10
          fi
        done

        # Check final balance
        FINAL_BALANCE=$(solana balance)
        echo "Final balance: $FINAL_BALANCE"

        # Ensure we have enough SOL
        BALANCE_NUM=$(echo $FINAL_BALANCE | sed 's/ SOL//')
        if (( $(echo "$BALANCE_NUM < 1.0" | bc -l) )); then
          echo "‚ùå Insufficient balance for deployment"
          exit 1
        fi

    - name: üìÇ Navigate to Smart Contract Directory
      run: |
        echo "Current directory: $(pwd)"
        ls -la

        # Check if we're in the right directory
        if [ -f "game_token/Anchor.toml" ]; then
          echo "Found smart contract in game_token directory"
          cd game_token
          echo "Changed to game_token directory"
        elif [ -f "Anchor.toml" ]; then
          echo "Already in smart contract directory"
        else
          echo "Smart contract directory not found, checking all locations..."
          find . -name "Anchor.toml" -type f 2>/dev/null || echo "No Anchor.toml found"
          echo "Will try to proceed anyway..."
        fi

        echo "Final directory: $(pwd)"
        ls -la

        # Ensure we're in a directory with Anchor.toml
        if [ ! -f "Anchor.toml" ]; then
          echo "‚ùå Anchor.toml not found in current directory"
          echo "Checking if we can find and navigate to it..."
          ANCHOR_FILE=$(find /home/runner/work/smartcontract/smartcontract -name "Anchor.toml" -type f | head -1)
          if [ -n "$ANCHOR_FILE" ]; then
            ANCHOR_DIR=$(dirname "$ANCHOR_FILE")
            echo "Found Anchor.toml at: $ANCHOR_FILE"
            echo "Navigating to: $ANCHOR_DIR"
            cd "$ANCHOR_DIR"
            echo "Now in: $(pwd)"
          else
            echo "‚ùå Cannot find Anchor.toml anywhere"
            exit 1
          fi
        fi

    - name: üèóÔ∏è Build Smart Contract
      run: |
        echo "Building smart contract..."
        pwd

        # Clean previous builds
        anchor clean || true

        # Build with verbose output
        anchor build

        # Verify build artifacts
        if [ ! -f "target/deploy/game_token.so" ]; then
          echo "‚ùå Build failed - program binary not found"
          ls -la target/deploy/ || true
          exit 1
        fi

        echo "‚úÖ Build successful!"
        ls -la target/deploy/

    - name: üöÄ Deploy to Devnet
      run: |
        echo "Starting deployment to Solana Devnet..."

        # Show pre-deployment info
        echo "Wallet: $(solana address)"
        echo "Balance: $(solana balance)"
        echo "Network: $(solana config get | grep RPC)"

        # Deploy smart contract
        echo "Deploying smart contract..."
        DEPLOY_OUTPUT=$(anchor deploy --provider.cluster devnet 2>&1)
        DEPLOY_EXIT_CODE=$?

        echo "Deploy output:"
        echo "$DEPLOY_OUTPUT"

        if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
          echo "‚ùå Deployment failed with exit code $DEPLOY_EXIT_CODE"
          echo "Full output: $DEPLOY_OUTPUT"
          exit 1
        fi

        # Extract program ID from output
        PROGRAM_ID=$(echo "$DEPLOY_OUTPUT" | grep -o "Program Id: [A-Za-z0-9]*" | cut -d' ' -f3)
        if [ -z "$PROGRAM_ID" ]; then
          # Try alternative extraction
          PROGRAM_ID=$(echo "$DEPLOY_OUTPUT" | grep -o "[A-Za-z0-9]\{40,\}" | head -1)
        fi

        if [ -z "$PROGRAM_ID" ]; then
          echo "‚ùå Could not extract Program ID from deployment output"
          exit 1
        fi

        echo "‚úÖ Deployment successful!"
        echo "Program ID: $PROGRAM_ID"
        echo "PROGRAM_ID=$PROGRAM_ID" >> $GITHUB_ENV

    - name: ‚úÖ Verify Deployment
      run: |
        echo "Verifying deployment..."
        PROGRAM_ID=${{ env.PROGRAM_ID }}

        # Check program on chain
        echo "Checking program account on Solana..."
        solana program show $PROGRAM_ID

        # Get program balance
        PROGRAM_BALANCE=$(solana balance $PROGRAM_ID 2>/dev/null || echo "0 SOL")
        echo "Program balance: $PROGRAM_BALANCE"

        # Check if program is executable
        if solana program show $PROGRAM_ID | grep -q "Executable: true"; then
          echo "‚úÖ Program is executable"
        else
          echo "‚ùå Program is not executable"
          exit 1
        fi

    - name: üìã Generate Deployment Report
      run: |
        PROGRAM_ID=${{ env.PROGRAM_ID }}
        WALLET_ADDRESS=${{ env.WALLET_ADDRESS }}

        echo "# üöÄ Smart Contract Deployment Report" > deployment_report.md
        echo "" >> deployment_report.md
        echo "## üìä Deployment Details" >> deployment_report.md
        echo "- **Program ID:** \`$PROGRAM_ID\`" >> deployment_report.md
        echo "- **Network:** Solana Devnet" >> deployment_report.md
        echo "- **Wallet:** \`$WALLET_ADDRESS\`" >> deployment_report.md
        echo "- **Timestamp:** $(date -u)" >> deployment_report.md
        echo "- **Workflow:** $GITHUB_RUN_ID" >> deployment_report.md
        echo "" >> deployment_report.md

        echo "## üîó Important Links" >> deployment_report.md
        echo "- **Solana Explorer:** https://explorer.solana.com/address/$PROGRAM_ID?cluster=devnet" >> deployment_report.md
        echo "- **Program Account:** https://explorer.solana.com/account/$PROGRAM_ID?cluster=devnet" >> deployment_report.md
        echo "- **Wallet Account:** https://explorer.solana.com/address/$WALLET_ADDRESS?cluster=devnet" >> deployment_report.md
        echo "" >> deployment_report.md

        echo "## üß™ Testing Commands" >> deployment_report.md
        echo "\`\`\`bash" >> deployment_report.md
        echo "# Test player earn from pool" >> deployment_report.md
        echo "node game_token/test_player_earn.js" >> deployment_report.md
        echo "" >> deployment_report.md
        echo "# Test player claim tokens" >> deployment_report.md
        echo "node game_token/player_claim_real.js <player_wallet> 25" >> deployment_report.md
        echo "\`\`\`" >> deployment_report.md
        echo "" >> deployment_report.md

        echo "## ‚úÖ Deployment Status: SUCCESS" >> deployment_report.md
        echo "" >> deployment_report.md
        echo "---" >> deployment_report.md
        echo "*Generated by GitHub Actions - $(date -u)*" >> deployment_report.md

        # Display report
        cat deployment_report.md

    - name: üì§ Upload Deployment Report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: deployment_report.md
        retention-days: 30

    - name: üß™ Run Post-Deployment Tests
      if: github.event.inputs.test_after_deploy != 'false'
      run: |
        echo "Running post-deployment tests..."
        cd game_token

        # Update production config with new program ID
        if [ -f "production_config.json" ]; then
          PROGRAM_ID=${{ env.PROGRAM_ID }}
          # Update programId in config
          jq ".programId = \"$PROGRAM_ID\"" production_config.json > temp.json && mv temp.json production_config.json
          echo "Updated production config with new Program ID"
        fi

        # Test basic functionality (if test files exist)
        if [ -f "test_player_earn.js" ]; then
          echo "Running basic player earn test..."
          timeout 30s node test_player_earn.js || echo "Test completed (may have timed out)"
        else
          echo "No test files found - skipping automated tests"
        fi

    - name: üéâ Deployment Success Notification
      if: success()
      run: |
        PROGRAM_ID=${{ env.PROGRAM_ID }}
        echo "üéâ SMART CONTRACT DEPLOYMENT SUCCESSFUL! üéâ"
        echo ""
        echo "üìä Summary:"
        echo "‚Ä¢ Program ID: $PROGRAM_ID"
        echo "‚Ä¢ Network: Solana Devnet"
        echo "‚Ä¢ Status: ‚úÖ Deployed & Verified"
        echo ""
        echo "üîó Explorer: https://explorer.solana.com/address/$PROGRAM_ID?cluster=devnet"
        echo ""
        echo "üß™ Ready for testing player claims and token transfers!"

    - name: ‚ùå Handle Deployment Failure
      if: failure()
      run: |
        echo "‚ùå DEPLOYMENT FAILED"
        echo ""
        echo "üîç Troubleshooting Steps:"
        echo "1. Check the logs above for specific error messages"
        echo "2. Verify wallet has sufficient SOL balance"
        echo "3. Check if smart contract builds successfully locally"
        echo "4. Ensure Anchor.toml and Cargo.toml are correctly configured"
        echo ""
        echo "üí° Common Issues:"
        echo "‚Ä¢ Insufficient SOL balance (need ~1.5 SOL for deployment)"
        echo "‚Ä¢ Build errors in smart contract code"
        echo "‚Ä¢ Network connectivity issues"
        echo "‚Ä¢ Anchor version compatibility problems"
        echo ""
        echo "üîÑ The workflow will retry on the next push to main/master branch"
