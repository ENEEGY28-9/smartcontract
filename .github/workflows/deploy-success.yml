name: Deploy Solana Smart Contract Success

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@1.70.0

    - name: Setup Solana CLI
      run: |
        curl -sSfL https://release.solana.com/v1.18.4/install | sh
        export PATH=$HOME/.local/share/solana/install/active_release/bin:$PATH

    - name: Setup Anchor
      run: |
        cargo install --git https://github.com/coral-xyz/anchor --tag v0.29.0 anchor-cli --locked

    - name: Force Anchor version
      run: |
        export PATH=$HOME/.cargo/bin:$PATH
        anchor --version

    - name: Build smart contract
      run: |
        export PATH=$HOME/.cargo/bin:$PATH
        anchor build

    - name: Deploy to devnet
      run: |
        export PATH=$HOME/.cargo/bin:$PATH
        mkdir -p ~/.config/solana
        echo ${{ secrets.SOLANA_PRIVATE_KEY }} > ~/.config/solana/id.json
        chmod 600 ~/.config/solana/id.json
        solana config set --url devnet --keypair ~/.config/solana/id.json
        solana airdrop 2 || true
        anchor deploy

    - name: Extract Program ID
      run: |
        export PATH=$HOME/.cargo/bin:$PATH
        PROGRAM_ID=$(solana address -k target/deploy/game_token-keypair.json)
        echo Program ID: $PROGRAM_ID
        echo ## Deployment Report > deployment_report.md
        echo - Program ID: $PROGRAM_ID >> deployment_report.md
        echo - Explorer: https://explorer.solana.com/address/$PROGRAM_ID?cluster=devnet >> deployment_report.md

    - name: Upload report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: deployment_report.md
