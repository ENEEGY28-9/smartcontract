name: ðŸš€ Deploy Solana Smart Contract

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: â›“ï¸ Setup Solana CLI
      uses: solana-labs/actions/cli@v1.0.3

    - name: âš“ Setup Anchor
      run: |
        cargo install --git https://github.com/coral-xyz/anchor avm --locked
        avm install latest
        avm use latest

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ðŸ“¦ Install dependencies
      run: npm install

    - name: ðŸ§¹ Clean previous builds
      run: anchor clean

    - name: ðŸ”¨ Build smart contract
      run: anchor build

    - name: ðŸš€ Deploy to devnet
      run: anchor deploy
      env:
        ANCHOR_PROVIDER_URL: https://api.devnet.solana.com
        ANCHOR_WALLET: ~/.config/solana/id.json

    - name: ðŸ” Extract Program ID
      id: program-id
      run: |
        # Extract Program ID from anchor deploy output
        PROGRAM_ID=$(solana address -k target/deploy/game_token-keypair.json)
        echo "program_id=$PROGRAM_ID" >> $GITHUB_OUTPUT
        echo "ðŸŽ¯ Deployed Program ID: $PROGRAM_ID"

    - name: âœ… Verify deployment
      run: |
        PROGRAM_ID="${{ steps.program-id.outputs.program_id }}"
        echo "ðŸ” Verifying program: $PROGRAM_ID"
        solana program show "$PROGRAM_ID"

    - name: ðŸ“Š Generate deployment report
      run: |
        PROGRAM_ID="${{ steps.program-id.outputs.program_id }}"
        cat > deployment_report.md << EOF
        # ðŸš€ Smart Contract Deployment Report

        ## ðŸ“… Deployment Info
        - **Time**: $(date)
        - **GitHub Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        - **Commit**: ${{ github.sha }}
        - **Branch**: ${{ github.ref_name }}

        ## ðŸŽ¯ Program Details
        - **Program ID**: \`$PROGRAM_ID\`
        - **Network**: Devnet
        - **Explorer**: https://explorer.solana.com/address/$PROGRAM_ID?cluster=devnet

        ## ðŸ“¦ Build Info
        - **Rust Version**: $(rustc --version)
        - **Solana CLI**: $(solana --version)
        - **Anchor Version**: $(anchor --version)

        ## âœ… Deployment Status
        - Build: âœ… Success
        - Deploy: âœ… Success
        - Verify: âœ… Success

        ## ðŸ§ª Testing
        - Manual testing required
        - Update client code with Program ID: \`$PROGRAM_ID\`

        ## ðŸŽ‰ Next Steps
        1. Test smart contract functionality
        2. Update frontend with new Program ID
        3. Deploy to mainnet when ready
        EOF

    - name: ðŸ“¤ Upload deployment report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: deployment_report.md

    - name: ðŸ“¢ Comment on PR/Issue
      if: github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('deployment_report.md', 'utf8');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
