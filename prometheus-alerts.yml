groups:
  - name: gamev1_backend
    rules:

    # Critical Alerts
    - alert: GatewayDown
      expr: up{job="gateway"} == 0
      for: 1m
      labels:
        severity: critical
        service: gateway
      annotations:
        summary: "Gateway service is down"
        description: "Gateway has been down for more than 1 minute."

    - alert: HighErrorRate
      expr: sum(rate(gateway_http_requests_total{status=~\"5..\"}[5m])) / sum(rate(gateway_http_requests_total[5m])) * 100 > 5
      for: 2m
      labels:
        severity: critical
        service: gateway
      annotations:
        summary: "High error rate detected"
        description: "Error rate is {{ $value }}% which is above 5% threshold."

    - alert: HighResponseTime
      expr: histogram_quantile(0.95, sum(rate(gateway_http_request_duration_seconds_bucket[5m])) by (le)) > 0.5
      for: 3m
      labels:
        severity: critical
        service: gateway
      annotations:
        summary: "High response time detected"
        description: "95th percentile response time is {{ $value }}s which is above 0.5s threshold."

    - alert: TooManyWebSocketConnections
      expr: sum(gateway_websocket_connections) > 1000
      for: 5m
      labels:
        severity: critical
        service: gateway
      annotations:
        summary: "Too many WebSocket connections"
        description: "Current WebSocket connections: {{ $value }}. Above 1000 threshold."

    - alert: HighMemoryUsage
      expr: sum(gateway_memory_usage_bytes) / 1024 / 1024 / 1024 > 2
      for: 2m
      labels:
        severity: critical
        service: gateway
      annotations:
        summary: "High memory usage"
        description: "Memory usage is {{ $value }}GB which is above 2GB threshold."

    # Warning Alerts
    - alert: ElevatedErrorRate
      expr: sum(rate(gateway_http_requests_total{status=~\"5..\"}[5m])) / sum(rate(gateway_http_requests_total[5m])) * 100 > 1
      for: 5m
      labels:
        severity: warning
        service: gateway
      annotations:
        summary: "Elevated error rate"
        description: "Error rate is {{ $value }}% which is above 1% threshold."

    - alert: SlowResponseTime
      expr: histogram_quantile(0.95, sum(rate(gateway_http_request_duration_seconds_bucket[5m])) by (le)) > 0.2
      for: 5m
      labels:
        severity: warning
        service: gateway
      annotations:
        summary: "Slow response time"
        description: "95th percentile response time is {{ $value }}s which is above 0.2s threshold."

    - alert: ManyRateLimitedRequests
      expr: sum(rate(gateway_rate_limited_requests_total[5m])) > 20
      for: 3m
      labels:
        severity: warning
        service: gateway
      annotations:
        summary: "Many rate limited requests"
        description: "Rate limited requests per second: {{ $value }}. Above 20 threshold."

    - alert: DatabaseConnectionPoolHigh
      expr: sum(gateway_database_connections) > 20
      for: 5m
      labels:
        severity: warning
        service: gateway
      annotations:
        summary: "High database connection pool usage"
        description: "Database connections: {{ $value }}. Above 20 threshold."

    # Game-specific Alerts
    - alert: HighGameLatency
      expr: histogram_quantile(0.95, sum(rate(gateway_game_latency_seconds_bucket[5m])) by (le)) > 0.1
      for: 3m
      labels:
        severity: warning
        service: game
      annotations:
        summary: "High game latency detected"
        description: "95th percentile game latency is {{ $value }}s which is above 0.1s threshold."

    - alert: LowPredictionAccuracy
      expr: avg(gateway_game_prediction_accuracy) < 70
      for: 5m
      labels:
        severity: warning
        service: game
      annotations:
        summary: "Low client prediction accuracy"
        description: "Average prediction accuracy is {{ $value }}% which is below 70% threshold."

    - alert: HighLatencyCompensation
      expr: avg(gateway_game_latency_compensation_ms) > 100
      for: 5m
      labels:
        severity: warning
        service: game
      annotations:
        summary: "High latency compensation applied"
        description: "Average latency compensation is {{ $value }}ms which is above 100ms threshold."

    # Info Alerts
    - alert: HighPlayerCount
      expr: sum(gateway_game_room_player_count) > 500
      for: 10m
      labels:
        severity: info
        service: game
      annotations:
        summary: "High player count"
        description: "Total players across all rooms: {{ $value }}. Above 500 threshold."

    - alert: ManyActiveRooms
      expr: sum(gateway_game_active_rooms) > 50
      for: 15m
      labels:
        severity: info
        service: game
      annotations:
        summary: "Many active game rooms"
        description: "Active game rooms: {{ $value }}. Above 50 threshold."

    - alert: HighGameMessageRate
      expr: sum(rate(gateway_game_messages_total[5m])) > 1000
      for: 5m
      labels:
        severity: info
        service: game
      annotations:
        summary: "High game message rate"
        description: "Game messages per second: {{ $value }}. Above 1000 threshold."
